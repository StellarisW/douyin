# ğŸ¶ Douyinï¼ˆç¬¬äº”å±Šå­—èŠ‚è·³åŠ¨é’è®­è¥åç«¯è€ƒæ ¸é¡¹ç›®ï¼‰

[![build](https://img.shields.io/badge/build-1.0.0-brightgreen)](https://github.com/StellarisW/douyin)[![go-version](https://img.shields.io/badge/go-~%3D1.19-30dff3?logo=go)](https://github.com/StellarisW/douyin)[![OpenTracing Badge](https://img.shields.io/badge/OpenTracing-enabled-blue.svg)](http://opentracing.io)

## ğŸ’¡ é¡¹ç›®ç®€ä»‹

> ä»“åº“: [https://github.com/StellarisW/Douyin]()

æœ¬é¡¹ç›®å®Œæˆäº†æŠ–éŸ³çš„ç®€å•åç«¯ï¼Œä¸»è¦å®ç°äº†åŠŸèƒ½æœ‰ï¼šç”¨æˆ·çš„æ³¨å†Œä¸ç™»å½•ï¼Œè§†é¢‘feedæµï¼Œè§†é¢‘æŠ•ç¨¿ï¼Œç”¨æˆ·å…³æ³¨ï¼ŒèŠå¤©ç­‰æ“ä½œ

## ğŸŒŸ é¡¹ç›®ç‰¹ç‚¹

## ğŸš€ åŠŸèƒ½ä»‹ç»

åŠŸèƒ½æŒ‰ç…§**ç³»ç»Ÿï¼ˆä»£ç ï¼‰æ¶æ„**åˆ†ç±»

## ğŸ“Š åŸºå‡†æµ‹è¯•

## ğŸ—¼ é¡¹ç›®è®¾è®¡

### æŠ€æœ¯æ ˆ

<img src="./manifest/docs/image/apollo.svg" width="10%">

- [apollo](https://www.apolloconfig.com/)

> ä¸€æ¬¾å¯é çš„åˆ†å¸ƒå¼é…ç½®ç®¡ç†ä¸­å¿ƒï¼Œè¯ç”Ÿäºæºç¨‹æ¡†æ¶ç ”å‘éƒ¨ï¼Œèƒ½å¤Ÿé›†ä¸­åŒ–ç®¡ç†åº”ç”¨ä¸åŒç¯å¢ƒã€ä¸åŒé›†ç¾¤çš„é…ç½®ï¼Œé…ç½®ä¿®æ”¹åèƒ½å¤Ÿå®æ—¶æ¨é€åˆ°åº”ç”¨ç«¯ï¼Œå¹¶ä¸”å…·å¤‡è§„èŒƒçš„æƒé™ã€æµç¨‹æ²»ç†ç­‰ç‰¹æ€§ï¼Œé€‚ç”¨äºå¾®æœåŠ¡é…ç½®ç®¡ç†åœºæ™¯ã€‚

ä½¿ç”¨apolloåšé…ç½®ç®¡ç†ç³»ç»Ÿï¼Œå¯ä»¥æœ‰æ•ˆçš„åœ¨è®¤è¯ç³»ç»Ÿï¼Œç”¨æˆ·ç³»ç»Ÿç­‰ç­‰ä¸åŒçš„ç¯å¢ƒä¸‹è¿›è¡Œé…ç½®çš„ç®¡ç†

<img src="./manifest/docs/image/go-zero.png">

- [go-zero](https://go-zero.dev/)

> ä¸€ä¸ªé›†æˆäº†å„ç§å·¥ç¨‹å®è·µçš„åŒ…å« å¾®æœåŠ¡æ¡†æ¶ã€‚
>
> å®ƒå…·æœ‰é«˜æ€§èƒ½ï¼ˆé«˜å¹¶å‘æ”¯æ’‘ï¼Œè‡ªåŠ¨ç¼“å­˜æ§åˆ¶ï¼Œè‡ªé€‚åº”ç†”æ–­ï¼Œè´Ÿè½½å‡è¡¡ï¼‰ã€æ˜“æ‹“å±•ï¼ˆæ”¯æŒä¸­é—´ä»¶ï¼Œæ–¹ä¾¿æ‰©å±•ï¼Œé¢å‘æ•…éšœç¼–ç¨‹ï¼Œå¼¹æ€§è®¾è®¡ï¼‰ã€ä½é—¨æ§›ï¼ˆå¤§é‡å¾®æœåŠ¡æ²»ç†å’Œå¹¶å‘å·¥å…·åŒ…ã€goctlè‡ªåŠ¨ç”Ÿæˆä»£ç å¾ˆé¦™ï¼‰ï¼Œ

åŒæ—¶go-zeroä¹Ÿæ˜¯ç°åœ¨æœ€æµè¡Œçš„goå¾®æœåŠ¡æ¡†æ¶ï¼Œæ‰€ä»¥æœ¬é¡¹ç›®é‡‡ç”¨go-zeroä¸ºä¸»æ¡†æ¶æ­å»ºåç«¯

<img src="./manifest/docs/image/mysql.svg">

- [mysql](https://www.mysql.com/)

> ä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œç”±ç‘å…¸MySQL AB å…¬å¸å¼€å‘ï¼Œå±äº Oracle æ——ä¸‹äº§å“ã€‚MySQL æ˜¯æœ€æµè¡Œçš„å…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¹‹ä¸€ï¼Œåœ¨ WEB åº”ç”¨æ–¹é¢ï¼ŒMySQLæ˜¯æœ€å¥½çš„ RDBMS (Relational Database Management Systemï¼Œå…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ) åº”ç”¨è½¯ä»¶ä¹‹ä¸€

å…³ç³»å‹æ•°æ®åº“é€‰å‹



<img src="./manifest/docs/image/minio.png"  width="30%">

- [minio](https://min.io/)

> `MinIO`æ˜¯ä¸€ä¸ªç”¨`Golang`å¼€å‘çš„åŸºäº`Apache License v2.0`å¼€æºåè®®çš„`é«˜æ€§èƒ½å¯¹è±¡å­˜å‚¨æœåŠ¡`ã€‚
>
> å®ƒå…¼å®¹äºšé©¬é€ŠS3äº‘å­˜å‚¨æœåŠ¡æ¥å£ï¼Œéå¸¸é€‚åˆäºå­˜å‚¨å¤§å®¹é‡éç»“æ„åŒ–çš„æ•°æ®ï¼Œä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ—¥å¿—æ–‡ä»¶ã€å¤‡ä»½æ•°æ®å’Œå®¹å™¨/è™šæ‹Ÿæœºé•œåƒç­‰ï¼Œè€Œä¸€ä¸ªå¯¹è±¡æ–‡ä»¶å¯ä»¥æ˜¯ä»»æ„å¤§å°ï¼Œä»å‡ kbåˆ°æœ€å¤§5Tä¸ç­‰ã€‚

æœ¬é¡¹ç›®ä½¿ç”¨minioä½œä¸ºå¯¹è±¡å­˜å‚¨å¹³å°

<img src="./manifest/docs/image/nsq.png" width="15%">

- [nsq](https://nsq.io/)

>  Go è¯­è¨€ç¼–å†™çš„å¼€æºåˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œå…·å¤‡éå¸¸å¥½çš„æ€§èƒ½ã€æ˜“ç”¨æ€§å’Œå¯ç”¨æ€§

â€‹    åˆšå¼€å§‹æƒ³ç”¨RabbitMQï¼Œä½†æ˜¯å¾ˆéš¾åšåˆ°é›†ç¾¤å’Œæ°´å¹³æ‰©å±•ï¼Œå†çœ‹äº†çœ‹å…¶ä»–çš„é˜Ÿåˆ—ç»„ä»¶ï¼ˆDarnerï¼ŒRedisï¼ŒKestrelå’ŒKafkaï¼‰ï¼Œæ¯ç§é˜Ÿåˆ—ç»„ä»¶éƒ½æœ‰ä¸åŒçš„æ¶ˆæ¯ä¼ è¾“ä¿     	è¯ï¼Œä½†ä¼¼ä¹å¹¶æ²¡æœ‰ä¸€ç§èƒ½åœ¨å¯æ‰©å±•æ€§å’Œæ“ä½œç®€æ˜“æ€§ä¸Šéƒ½æ¯”è¾ƒä¼˜ç§€çš„äº§å“ã€‚

â€‹    ç„¶åå°±çœ‹åˆ°äº†nsqï¼Œæ”¯æŒæ¨ªå‘æ‹“å±•ï¼Œæ€§èƒ½ä¹Ÿå¾ˆå¥½ï¼ŒåŒæ—¶ä¹Ÿæ˜¯goè¯­è¨€åŸç”Ÿå¼€å‘çš„ï¼Œå› æ­¤é€‰å‹nsq

<img src="./manifest/docs/image/asynq.png" width="15%">

- [asynq](https://github.com/hibiken/asynq)

> goè¯­è¨€å®ç°çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—å’Œå¼‚æ­¥å¤„ç†åº“ï¼ŒåŸºäºredisï¼Œç±»ä¼¼sidekiqå’Œcelery

â€‹	asynqæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ¬é¡¹ç›®ç”¨å®ƒè¿›è¡Œå¼‚æ­¥åŠå®šæ—¶ä»»åŠ¡å¤„ç†

<img src="./manifest/docs/image/redis.svg">

- [redis](https://redis.io/)

> ä¸€ä¸ªå¼€æºçš„ã€ä½¿ç”¨Cè¯­è¨€ç¼–å†™çš„ã€æ”¯æŒç½‘ç»œäº¤äº’çš„ã€å¯åŸºäºå†…å­˜ä¹Ÿå¯æŒä¹…åŒ–çš„Key-Valueæ•°æ®åº“ã€‚

ç¼“å­˜å­˜å‚¨è¿˜æ˜¯é€‰å‹æœ€æ™®éçš„redis

<img src="./manifest/docs/image/consul.svg" width="25%">

- [consul](https://www.consul.io/)

> ä¸€å¥—å¼€æºçš„åˆ†å¸ƒå¼æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†ç³»ç»Ÿï¼Œç”±HasiCorpå…¬å¸ç”¨goè¯­è¨€å¼€å‘çš„ã€‚æä¾›äº†å¾®æœåŠ¡ç³»ç»Ÿä¸­æœåŠ¡åŠ©ç†ã€é…ç½®ä¸­å¿ƒã€æ§åˆ¶æ€»çº¿ç­‰åŠŸèƒ½ã€‚

åœ¨consulå’Œetcdä¹‹é—´æ¯”è¾ƒï¼Œconsulçš„æœåŠ¡å‘ç°å¾ˆæ–¹ä¾¿ï¼Œä¹Ÿæœ‰å¥åº·æ£€æŸ¥ï¼Œå¤šæ•°æ®ä¸­å¿ƒç­‰åŠŸèƒ½ï¼ŒåŒæ—¶ä¹Ÿæ˜¯goäº‘åŸç”Ÿé¡¹ç›®ï¼Œå› æ­¤é€‰å‹consul

<img src="./manifest/docs/image/jaeger.svg" width="15%">

- [jaeger](https://www.jaegertracing.io/)

> ç”±Uberå¼€æºçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ

go-zeroæ¡†æ¶é›†æˆäº†å¯¹jaegerçš„æ”¯æŒï¼Œå› æ­¤ä½¿ç”¨jaegeråšè¿½è¸ªç³»ç»Ÿ

<img src="./manifest/docs/image/traefik.png" width="20%">

- [traefik](https://www.jaegertracing.io/)

> ä¸€ä¸ªä¸ºäº†è®©éƒ¨ç½²å¾®æœåŠ¡æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£HTTPåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·ã€‚

æœ¬é¡¹ç›®å†™çš„å¾®æœåŠ¡å¾ˆå¤šï¼Œç”¨nginxéš¾ç®¡ç†ï¼Œä¹Ÿæ¯”è¾ƒæ‡’å¾—å†™é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥ç”¨traefikï¼Œè™½ç„¶æ€§èƒ½æ²¡nginxå¥½ï¼Œä½†æ˜¯å¯¹å¾®æœåŠ¡çš„åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„æ”¯æŒå¾ˆä¾¿æ·ï¼Œ

åŒæ—¶ä½¿ç”¨traefikä¸­çš„httpä¸­é—´ä»¶ï¼Œoauth proxyä¹Ÿå¾ˆæ–¹ä¾¿

### æ¶æ„å›¾

[ç‚¹å‡»æ”¾å¤§](./manifest/docs/image/architecture.svg)

<img src="./manifest/docs/image/architecture.png">

### ç›®å½•ç»“æ„

<details>
<summary>å±•å¼€æŸ¥çœ‹</summary>
<pre>
<code>
    â”œâ”€â”€ app -------------------------------------------- (é¡¹ç›®æ–‡ä»¶)
        â”œâ”€â”€ common ------------------------------------- (å…¨å±€é€šç”¨ç›®å½•)
        	â”œâ”€â”€ config --------------------------------- (è·å–é…ç½®æ–‡ä»¶ç›¸å…³)
        		â”œâ”€â”€ internal --------------------------- (é…ç½®ç»„ä»¶å†…éƒ¨åŒ…)
        			â”œâ”€â”€ common ------------------------- (é€šç”¨é…ç½®)
        			â”œâ”€â”€ consts ------------------------- (é…ç½®ç»„ä»¶å¸¸é‡å®šä¹‰)
        			â”œâ”€â”€ database ----------------------- (æ•°æ®åº“é…ç½®)
        			â”œâ”€â”€ middleware --------------------- (ä¸­é—´ä»¶é…ç½®)
        			â”œâ”€â”€ types -------------------------- (apollo, viper å¯¹è±¡)
        	â”œâ”€â”€ douyin ---------------------------------- (æœ¬é¡¹ç›®çš„é€šç”¨å¸¸é‡å’Œå‡½æ•°)
        	â”œâ”€â”€ errx ----------------------------------- (é”™è¯¯åŒ…)
        	â”œâ”€â”€ log ------------------------------------ (æ—¥å¿—é…ç½®)
        	â”œâ”€â”€ middleware ----------------------------- (ä¸­é—´ä»¶)
        	â”œâ”€â”€ model ---------------------------------- (å…¨å±€æ¨¡å‹)
        â”œâ”€â”€ service ------------------------------------ (å¾®æœåŠ¡)
            â”œâ”€â”€ auth ----------------------------------- (è®¤è¯ç³»ç»Ÿ)
            	â”œâ”€â”€ api -------------------------------- (apiæœåŠ¡ä»£ç )
            		â”œâ”€â”€ internal ----------------------- (apiæœåŠ¡å†…éƒ¨åŒ…)
            			â”œâ”€â”€ config --------------------- (æœåŠ¡é…ç½®)
            			â”œâ”€â”€ consts --------------------- (å¸¸é‡,åŒ…æ‹¬é”™è¯¯é€»è¾‘idå®šä¹‰)
            			â”œâ”€â”€ handler -------------------- (http handler)
            			â”œâ”€â”€ logic ---------------------- (ä¸šåŠ¡é€»è¾‘å‡½æ•°,è¢«handlerè°ƒç”¨)
            			â”œâ”€â”€ model ---------------------- (ä¸šåŠ¡æ¨¡å‹)
            				â”œâ”€â”€ token ------------------ (ä»¤ç‰Œä¸šåŠ¡æ¨¡å‹)
            			â”œâ”€â”€ svc ------------------------ (æœåŠ¡ä¸Šä¸‹æ–‡)
            			â”œâ”€â”€ types ---------------------- (httpè¯·æ±‚ç»“æ„ä½“å®šä¹‰)
            	â”œâ”€â”€ internal --------------------------- (è®¤è¯ç³»ç»Ÿå†…éƒ¨åŒ…)
            		â”œâ”€â”€ auth --------------------------- (ç³»ç»Ÿä¸šåŠ¡é€»è¾‘ç›¸å…³å…¬ç”¨çš„å¸¸é‡,ç»“æ„ä½“,å‡½æ•°)
            		â”œâ”€â”€ sys ---------------------------- (ç³»ç»Ÿç›¸å…³çš„å…¬ç”¨å¸¸é‡)
            	â”œâ”€â”€ rpc -------------------------------- (rpcæœåŠ¡ä»£ç )
            		â”œâ”€â”€ token -------------------------- (tokenç±» rpcæœåŠ¡)
            			â”œâ”€â”€ enhancer ------------------- (token-enhancer rpcæœåŠ¡)
            				â”œâ”€â”€ internal --------------- (token-enhancer rpcæœåŠ¡å†…éƒ¨åŒ…)
            					â”œâ”€â”€ config ------------- (æœåŠ¡é…ç½®)
            					â”œâ”€â”€ consts ------------- (å¸¸é‡,åŒ…æ‹¬é”™è¯¯é€»è¾‘idå®šä¹‰)
            					â”œâ”€â”€ logic -------------- (ä¸šåŠ¡é€»è¾‘å‡½æ•°,è¢«rpcè°ƒç”¨)
            					â”œâ”€â”€ model -------------- (ä¸šåŠ¡æ¨¡å‹)
            						â”œâ”€â”€ jwt ------------ (jwtæ¨¡å‹)
            					â”œâ”€â”€ server ------------- (rpcè°ƒç”¨å‡½æ•°)
            					â”œâ”€â”€ svc ---------------- (æœåŠ¡ä¸Šä¸‹æ–‡)
            				â”œâ”€â”€ pb --------------------- (pbå®šä¹‰æ–‡ä»¶)
            				â”œâ”€â”€ tokenenhancer ---------- (rpcæœåŠ¡è°ƒç”¨)
            			â”œâ”€â”€ store ---------------------- (token-store rpcæœåŠ¡)
            				â”œâ”€â”€ internal --------------- (token-store rpcæœåŠ¡å†…éƒ¨åŒ…)
            					â”œâ”€â”€ config ------------- (æœåŠ¡é…ç½®)
            					â”œâ”€â”€ consts ------------- (å¸¸é‡,åŒ…æ‹¬é”™è¯¯é€»è¾‘idå®šä¹‰)
            					â”œâ”€â”€ logic -------------- (ä¸šåŠ¡é€»è¾‘å‡½æ•°,è¢«rpcè°ƒç”¨)
            					â”œâ”€â”€ server ------------- (rpcè°ƒç”¨å‡½æ•°)
            					â”œâ”€â”€ svc ---------------- (æœåŠ¡ä¸Šä¸‹æ–‡)
            				â”œâ”€â”€ pb --------------------- (pbå®šä¹‰æ–‡ä»¶)
            				â”œâ”€â”€ tokenstore ------------- (rpcæœåŠ¡è°ƒç”¨)
            â”œâ”€â”€ chat ------------------------------ (èŠå¤©ç³»ç»Ÿ)
            	â”œâ”€â”€ api -------------------------------- (apiæœåŠ¡ä»£ç )
            		â”œâ”€â”€ internal ----------------------- (apiæœåŠ¡å†…éƒ¨åŒ…)
            			â”œâ”€â”€ config --------------------- (æœåŠ¡é…ç½®)
            			â”œâ”€â”€ consts --------------------- (å¸¸é‡,åŒ…æ‹¬é”™è¯¯idå®šä¹‰)
            			â”œâ”€â”€ handler -------------------- (http handler)
            			â”œâ”€â”€ logic ---------------------- (ä¸šåŠ¡é€»è¾‘å‡½æ•°,è¢«handlerè°ƒç”¨)
            			â”œâ”€â”€ svc ------------------------ (æœåŠ¡ä¸Šä¸‹æ–‡)
            			â”œâ”€â”€ types ---------------------- (httpè¯·æ±‚ç»“æ„ä½“å®šä¹‰)
            	â”œâ”€â”€ internal --------------------------- (èŠå¤©ç³»ç»Ÿå†…éƒ¨åŒ…)
            		â”œâ”€â”€ char ---------------------- (ç³»ç»Ÿä¸šåŠ¡é€»è¾‘ç›¸å…³å…¬ç”¨çš„å¸¸é‡,ç»“æ„ä½“,å‡½æ•°)
            		â”œâ”€â”€ sys ---------------------------- (ç³»ç»Ÿç›¸å…³çš„å…¬ç”¨å¸¸é‡)
            	â”œâ”€â”€ rpc -------------------------------- (rpcæœåŠ¡ä»£ç )
            		â”œâ”€â”€ sys ---------------------------- (sys rpc æœåŠ¡)
            			â”œâ”€â”€ internal ------------------- (sys rpc æœåŠ¡å†…éƒ¨åŒ…)
            				â”œâ”€â”€ config ----------------- (æœåŠ¡é…ç½®)
            				â”œâ”€â”€ logic ------------------ (ä¸šåŠ¡é€»è¾‘å‡½æ•°,è¢«rpcè°ƒç”¨)
            				â”œâ”€â”€ model ------------------ (ä¸šåŠ¡æ¨¡å‹)
            					â”œâ”€â”€ dao ---------------- (æ•°æ®åº“æ¨¡å‹)
            						â”œâ”€â”€ entity --------- (æ•°æ®åº“å®ä½“)
            				â”œâ”€â”€ server ----------------- (rpcè°ƒç”¨å‡½æ•°)
            				â”œâ”€â”€ svc -------------------- (æœåŠ¡ä¸Šä¸‹æ–‡)
            			â”œâ”€â”€ pb ------------------------- (pbå®šä¹‰æ–‡ä»¶)
            			â”œâ”€â”€ sys ------------------------ (rpcæœåŠ¡è°ƒç”¨)
            â”œâ”€â”€ mq ----------------------------------- (æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ)
            	â”œâ”€â”€ nsq ------------------------------ (nsq åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—)
            		â”œâ”€â”€ consumer --------------------- (nsq æ¶ˆè´¹è€…)
            			â”œâ”€â”€ internal ----------------- (nsq æ¶ˆè´¹è€…å†…éƒ¨åŒ…)
            				â”œâ”€â”€ config --------------- (æœåŠ¡é…ç½®)
            				â”œâ”€â”€ listen --------------- (ç›‘å¬é…ç½®)
            					â”œâ”€â”€ chat ------------- (èŠå¤©æ¨¡å—ç›¸å…³)
            					â”œâ”€â”€ user ------------- (ç”¨æˆ·æ¨¡å—ç›¸å…³)
            					â”œâ”€â”€ video ------------ (è§†é¢‘æ¨¡å—ç›¸å…³)
            				â”œâ”€â”€ svc ------------------ (æœåŠ¡ä¸Šä¸‹æ–‡)
            		â”œâ”€â”€ internal --------------------- (nsq å†…éƒ¨åŒ…)
            			â”œâ”€â”€ consts ------------------- (nsq ç›¸å…³çš„å…¬ç”¨å¸¸é‡)
            		â”œâ”€â”€ producer --------------------- (nsq ç”Ÿäº§è€…)
            			â”œâ”€â”€ chat --------------------- (èŠå¤©æ¨¡å—ç›¸å…³)
            			â”œâ”€â”€ user --------------------- (ç”¨æˆ·æ¨¡å—ç›¸å…³)
            			â”œâ”€â”€ video -------------------- (è§†é¢‘æ¨¡å—ç›¸å…³)
            â”œâ”€â”€ user ----------------------------------- (ç”¨æˆ·ç³»ç»Ÿ)
            	â”œâ”€â”€ api -------------------------------- (apiæœåŠ¡ä»£ç )
            		â”œâ”€â”€ internal ----------------------- (apiæœåŠ¡å†…éƒ¨åŒ…)
            			â”œâ”€â”€ config --------------------- (æœåŠ¡é…ç½®)
            			â”œâ”€â”€ consts --------------------- (å¸¸é‡,åŒ…æ‹¬é”™è¯¯idå®šä¹‰)
            				â”œâ”€â”€ profile ------------------- (ä¸ªäººä¿¡æ¯ä¸šåŠ¡ç›¸å…³é€»è¾‘)
            				â”œâ”€â”€ relation ------------------ (å…³æ³¨ä¸šåŠ¡ç›¸å…³é€»è¾‘)
            				â”œâ”€â”€ sign ----------------- (æ³¨å†Œç™»å½•ä¸šåŠ¡ç›¸å…³é€»è¾‘)
            			â”œâ”€â”€ handler -------------------- (http handler)
            			â”œâ”€â”€ logic ---------------------- (ä¸šåŠ¡é€»è¾‘å‡½æ•°,è¢«handlerè°ƒç”¨)
            			â”œâ”€â”€ svc ------------------------ (æœåŠ¡ä¸Šä¸‹æ–‡)
            			â”œâ”€â”€ types ---------------------- (httpè¯·æ±‚ç»“æ„ä½“å®šä¹‰)
            	â”œâ”€â”€ internal --------------------------- (ç”¨æˆ·ç³»ç»Ÿå†…éƒ¨åŒ…)
            		â”œâ”€â”€ sys ---------------------------- (ç³»ç»Ÿç›¸å…³çš„å…¬ç”¨å¸¸é‡)
            		â”œâ”€â”€ user --------------------------- (ç³»ç»Ÿä¸šåŠ¡é€»è¾‘ç›¸å…³å…¬ç”¨çš„å¸¸é‡,ç»“æ„ä½“,å‡½æ•°)
            	â”œâ”€â”€ rpc -------------------------------- (rpcæœåŠ¡ä»£ç )
            		â”œâ”€â”€ sys ---------------------------- (sys rpc æœåŠ¡)
            			â”œâ”€â”€ internal ------------------- (sys rpc æœåŠ¡å†…éƒ¨åŒ…)
            				â”œâ”€â”€ config ----------------- (æœåŠ¡é…ç½®)
            				â”œâ”€â”€ logic ------------------ (ä¸šåŠ¡é€»è¾‘å‡½æ•°,è¢«rpcè°ƒç”¨)
            				â”œâ”€â”€ model ------------------ (ä¸šåŠ¡æ¨¡å‹)
            					â”œâ”€â”€ consts ------------- (å¸¸é‡,åŒ…æ‹¬é”™è¯¯é€»è¾‘idå®šä¹‰)
            					â”œâ”€â”€ dao ---------------- (æ•°æ®åº“æ¨¡å‹)
            						â”œâ”€â”€ entity --------- (æ•°æ®åº“å®ä½“)
            					â”œâ”€â”€ profile --------------- (ä¸ªäººä¿¡æ¯æ¨¡å‹)
            					â”œâ”€â”€ relation -------------- (å…³æ³¨æ¨¡å‹)
            					â”œâ”€â”€ sign ------------- (æ³¨å†Œç™»å½•æ¨¡å‹)
            			â”œâ”€â”€ server --------------------- (rpcè°ƒç”¨å‡½æ•°)
            			â”œâ”€â”€ svc ------------------------ (æœåŠ¡ä¸Šä¸‹æ–‡)
            		â”œâ”€â”€ pb ----------------------------- (pbå®šä¹‰æ–‡ä»¶)
            		â”œâ”€â”€ sys ---------------------------- (rpcæœåŠ¡è°ƒç”¨)
            â”œâ”€â”€ video ----------------------------------- (èŠå¤©ç³»ç»Ÿ)
            	â”œâ”€â”€ api -------------------------------- (apiæœåŠ¡ä»£ç )
            		â”œâ”€â”€ internal ----------------------- (apiæœåŠ¡å†…éƒ¨åŒ…)
            			â”œâ”€â”€ config --------------------- (æœåŠ¡é…ç½®)
            			â”œâ”€â”€ consts --------------------- (å¸¸é‡,åŒ…æ‹¬é”™è¯¯idå®šä¹‰)
            				â”œâ”€â”€ crud ------------------- (ä¿®æ”¹ä¸šåŠ¡ç›¸å…³é€»è¾‘)
            				â”œâ”€â”€ info ------------------- (æŸ¥è¯¢ä¸šåŠ¡ç›¸å…³é€»è¾‘)
            			â”œâ”€â”€ handler -------------------- (http handler)
            			â”œâ”€â”€ logic ---------------------- (ä¸šåŠ¡é€»è¾‘å‡½æ•°,è¢«handlerè°ƒç”¨)
            			â”œâ”€â”€ svc ------------------------ (æœåŠ¡ä¸Šä¸‹æ–‡)
            			â”œâ”€â”€ types ---------------------- (httpè¯·æ±‚ç»“æ„ä½“å®šä¹‰)
            	â”œâ”€â”€ internal --------------------------- (è§†é¢‘ç³»ç»Ÿå†…éƒ¨åŒ…)
            		â”œâ”€â”€ sys ---------------------------- (ç³»ç»Ÿç›¸å…³çš„å…¬ç”¨å¸¸é‡)
            		â”œâ”€â”€ video --------------------------- (ç³»ç»Ÿä¸šåŠ¡é€»è¾‘ç›¸å…³å…¬ç”¨çš„å¸¸é‡,ç»“æ„ä½“,å‡½æ•°)
            	â”œâ”€â”€ rpc -------------------------------- (rpcæœåŠ¡ä»£ç )
            		â”œâ”€â”€ sys ---------------------------- (sys rpc æœåŠ¡)
            			â”œâ”€â”€ internal ------------------- (sys rpc æœåŠ¡å†…éƒ¨åŒ…)
            				â”œâ”€â”€ config ----------------- (æœåŠ¡é…ç½®)
            				â”œâ”€â”€ logic ------------------ (ä¸šåŠ¡é€»è¾‘å‡½æ•°,è¢«rpcè°ƒç”¨)
            				â”œâ”€â”€ model ------------------ (ä¸šåŠ¡æ¨¡å‹)
            					â”œâ”€â”€ consts ------------- (å¸¸é‡,åŒ…æ‹¬é”™è¯¯é€»è¾‘idå®šä¹‰)
            					â”œâ”€â”€ crud --------------- (ä¿®æ”¹æ¨¡å‹)
            					â”œâ”€â”€ dao ---------------- (æ•°æ®åº“æ¨¡å‹)
            						â”œâ”€â”€ entity --------- (æ•°æ®åº“å®ä½“)
            					â”œâ”€â”€ info --------------- (æŸ¥è¯¢æ¨¡å‹)
            			â”œâ”€â”€ server --------------------- (rpcè°ƒç”¨å‡½æ•°)
            			â”œâ”€â”€ svc ------------------------ (æœåŠ¡ä¸Šä¸‹æ–‡)
            		â”œâ”€â”€ pb ----------------------------- (pbå®šä¹‰æ–‡ä»¶)
            		â”œâ”€â”€ sys ---------------------------- (rpcæœåŠ¡è°ƒç”¨)
    â”œâ”€â”€ manifest --------------------------------------- (äº¤ä»˜æ¸…å•)
    	â”œâ”€â”€ .goctl ------------------------------------- (goctlæ¨¡æ¿)
    	â”œâ”€â”€ docs --------------------------------------- (é¡¹ç›®æ–‡æ¡£)
    	â”œâ”€â”€ deploy ------------------------------------- (éƒ¨ç½²é…ç½®æ–‡ä»¶)
    		â”œâ”€â”€ docker --------------------------------- (dockeré…ç½®æ–‡ä»¶)
        â”œâ”€â”€ sql ---------------------------------------- (mysqlåˆå§‹åŒ–é…ç½®æ–‡ä»¶)
    â”œâ”€â”€ utils ------------------------------------------ (å·¥å…·åŒ…) 
        â”œâ”€â”€ file --------------------------------------- (å¯¹æ–‡ä»¶æ“ä½œçš„å‡½æ•°åŒ…)
        â”œâ”€â”€ redix -------------------------------------- (redisç›¸å…³æ“ä½œåŒ…)
</code>
</pre>
</details>



### ä¸­é—´ä»¶è®¾è®¡

#### Sentinel ä¸­é—´ä»¶

#### JWT ä¸­é—´ä»¶

### è®¤è¯æ¨¡å—è®¾è®¡

#### éœ€æ±‚åˆ†æ

è¯¥é¡¹ç›®çš„æ¥å£é™¤äº†ç”¨æˆ·æ³¨å†Œã€ç™»å½•ï¼ŒåŠè§†é¢‘æµæ¥å£å¤–çš†éœ€è¦åœ¨queryæˆ–formè¡¨å•é‡Œé¢æä¾›ç”¨æˆ·é‰´æƒtokenï¼Œ

æ‰€ä»¥è¯¥æ¨¡å—éœ€è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š

- åœ¨ç”¨æˆ·ç™»å½•åç»™ç”¨æˆ· **æä¾›** é‰´æƒtokenï¼Œ

- æ ¹æ®åœ¨å…¶ä»–æ¥å£çš„JWTä¸­é—´ä»¶ä¸­å‘é€çš„è¯·æ±‚ä¸­æä¾›çš„tokenï¼Œ**æ ¡éªŒ** tokenæœ‰æ•ˆæ€§åŠ **è§£æ** å…¶ä¸­çš„ç”¨æˆ·ä¿¡æ¯

#### æ¶æ„è®¾è®¡

<img src="./manifest/docs/image/auth-module.png">

#### ä»¤ç‰Œçš„é¢å‘ä¸æ ¡éªŒ

ä¸šåŠ¡é€»è¾‘ä¸»è¦é€šè¿‡ **ä»¤ç‰Œé¢å‘å™¨æ¥å£** å’Œ **ä»¤ç‰ŒæœåŠ¡æ¥å£** å®ç°

##### ä»¤ç‰Œé¢å‘å™¨

```go
type (
	// TokenGranter ä»¤ç‰Œé¢å‘å™¨æ¥å£
	TokenGranter interface {
		Grant(ctx context.Context, grantType string, auth string, obj string) (*auth.Token, errx.Error)
	}

	// ComposeTokenGranter é›†æˆä»¤ç‰Œé¢å‘å™¨
	ComposeTokenGranter struct {
		TokenGrantDict map[string]TokenGranter
	}

	// AuthorizationTokenGranter é€šè¿‡è®¤è¯ä»¤ç‰Œçš„é¢å‘å™¨ç»“æ„ä½“
	AuthorizationTokenGranter struct {
		SupportGrantType string
		ClientSecret     map[string]string
		TokenService     TokenService
	}
)
```

è¯¥æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³• `Grant()` ï¼Œç”¨æ¥é¢å‘ä»¤ç‰Œï¼Œ

ç›®å‰åªæœ‰ **Authorization** ä¸€ç§è®¤è¯æ–¹å¼ï¼Œè¯¥æ¥å£çš„å¥½å¤„æ˜¯å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼Œæ–¹ä¾¿ä»¥åæ‹“å±• **Oauth2 ç™»å½•**ç­‰å¤šç§ç™»å½•è®¤è¯æ–¹å¼

å‚æ•°è¯´æ˜ï¼š

- **granType**ï¼šé¢å‘ç±»å‹

    ç›®å‰æœ‰ä»¥ä¸‹ç±»å‹ï¼š

    - **Authorization**ï¼šæ ¹æ®Basic Authå¤´é¢å‘ä»¤ç‰Œ

- **auth**ï¼šè®¤è¯å‚æ•°

- **obj**ï¼šé¢å‘å¯¹è±¡

##### ä»¤ç‰ŒæœåŠ¡

```go
type (
	// TokenService ä»¤ç‰ŒæœåŠ¡æ¥å£
	TokenService interface {
		GenerateToken(ctx context.Context, subject string, audience string) (*auth.Token, errx.Error)
		ReadToken(ctx context.Context, tokenValue string) (string, errx.Error)
	}

	// DefaultTokenService é»˜è®¤ä»¤ç‰ŒæœåŠ¡ç»“æ„ä½“
	DefaultTokenService struct {
	}

	// RpcTokenService rpc ä»¤ç‰ŒæœåŠ¡ç»“æ„ä½“
	RpcTokenService struct {
		TokenEnhancerClient tokenenhancer.TokenEnhancer
	}
)
```

è¯¥æ¥å£å…±æœ‰ä¸¤ç§æ–¹æ³•ï¼š`GenerateToken()` ç”¨æ¥é¢å‘ä»¤ç‰Œï¼Œ`ReadToken()`ç”¨æ¥è¯»å–ä»¤ç‰Œ

è¯¥æ¥å£é€šè¿‡è°ƒç”¨ `TokenEnhancerClient` RpcæœåŠ¡å®ç°ä¸šåŠ¡é€»è¾‘

#### ä»¤ç‰Œè®¾è®¡

##### jwt è®¾è®¡

æœ¬é¡¹ç›® jwt é€šè¿‡ [jwx](https://github.com/lestrrat-go/jwx) å®ç°

- **header**

    Header éƒ¨åˆ†æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œæè¿° JWT çš„å…ƒæ•°æ®

    ```json
    {
      "typ": "JWT", // ä»¤ç‰Œç±»å‹
      "alg": "HS256" // åŠ å¯†ç®—æ³•
    }
    ```

- **payload**

    Payload éƒ¨åˆ†ä¹Ÿæ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œç”¨æ¥å­˜æ”¾å®é™…éœ€è¦ä¼ é€’çš„æ•°æ®

    å› ä¸º JWT é»˜è®¤æ˜¯ä¸åŠ å¯†çš„ï¼Œæ‰€ä»¥æœ¬é¡¹ç›®ä½¿ç”¨ `PBES2_HS512_A256KW` åŠ å¯†ç®—æ³•å°† payload åŠ å¯†åå†è¿›è¡Œç­¾åæ“ä½œ

    ```json
    {
      "iss": "douyin.xxx.com", // ç­¾å‘äºº
      "iat": 1516239022, // ç­¾å‘æ—¶é—´
      "sub": "StellarisW", // ä¸»é¢˜
      "aud": "douyin.xxx.com", // å—ä¼—
      "nbf": 1516239022, // ç”Ÿæ•ˆæ—¶é—´
      "exp": 1516339022 // è¿‡æœŸæ—¶é—´
    }
    ```

- **signature**

    Signature éƒ¨åˆ†æ˜¯å¯¹å‰ä¸¤éƒ¨åˆ†çš„ç­¾åï¼Œé˜²æ­¢æ•°æ®ç¯¡æ”¹ã€‚

    é¦–å…ˆï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå¯†é’¥ï¼ˆsecretï¼‰ã€‚è¿™ä¸ªå¯†é’¥åªæœ‰æœåŠ¡å™¨æ‰çŸ¥é“ï¼Œä¸èƒ½æ³„éœ²ç»™ç”¨æˆ·ã€‚

    ç„¶åï¼Œä½¿ç”¨ Header é‡Œé¢æŒ‡å®šçš„ç­¾åç®—æ³•ï¼ˆæœ¬é¡¹ç›®ä½¿ç”¨ HMAC SHA256ï¼‰ï¼ŒæŒ‰ç…§ä¸‹é¢çš„å…¬å¼äº§ç”Ÿç­¾å

    ç®—å‡ºç­¾åä»¥åï¼ŒæŠŠ Headerã€Payloadã€Signature ä¸‰ä¸ªéƒ¨åˆ†æ‹¼æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªéƒ¨åˆ†ä¹‹é—´ç”¨"ç‚¹"ï¼ˆ`.`ï¼‰åˆ†éš”ï¼Œå°±å¯ä»¥è¿”å›ç»™ç”¨æˆ·

    ```
    HMACSHA256(
      base64UrlEncode(header) + "." +
      base64UrlEncode(payload), 
    )
    ```

##### ç»“æ„ä½“ è®¾è®¡

```go
type Token struct {
	TokenValue string `json:"token_value,omitempty"` // ä»¤ç‰Œå€¼
	ExpiresAt  int64  `json:"expires_at,omitempty"`  // è¿‡æœŸæ—¶é—´ (unix)
}
```

##### ç”Ÿæˆä»¤ç‰Œæ–¹æ³•

```GO
// GenerateToken ç”Ÿæˆæˆæƒä»¤ç‰Œ
func GenerateToken(subject string, audience string, scope string) (*auth.Token, errx.Error) {
	// è§£ææˆæƒä»¤ç‰Œæœ‰æ•ˆæ—¶é—´
	accessTokenValidityTime, _ := time.ParseDuration(cast.ToString(auth.ClientDetails[audience].AccessTokenValidityTime))

	now := time.Now()

	// æ„å»ºæˆæƒä»¤ç‰Œ
	accessToken, err := jwt.NewBuilder().
		Issuer(issuer).
		IssuedAt(now).
		Subject(subject).
		Audience([]string{audience}).
		NotBefore(now.Truncate(time.Second)).
		Expiration(now.Add(accessTokenValidityTime)).
		Claim("scope", scope).
		Build()
	if err != nil {
		return nil, errTokenBuild
	}

	// å°†æˆæƒä»¤ç‰Œè¿›è¡ŒåŠ å¯†ç­¾å
	serializedAccessToken, err := jwt.NewSerializer().
		Encrypt(jwt.WithKey(jwa.PBES2_HS512_A256KW, encryptKey)).
		Sign(jwt.WithKey(jwa.HS256, signingKey)).
		Serialize(accessToken)
	if err != nil {
		return nil, errTokenSerialize
	}

	accessTokenValue := string(serializedAccessToken)

	return &auth.Token{
		TokenValue: accessTokenValue,
		ExpiresAt:  accessToken.Expiration().Unix(),
	}, nil
}
```

##### è§£æä»¤ç‰Œæ–¹æ³•

```go
// ParseToken è§£æä»¤ç‰Œ
func ParseToken(tokenValue string) (string, errx.Error) {
	var tokenBytes []byte

	// éªŒè¯ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
	payload, err := jws.Verify([]byte(tokenValue), jws.WithKey(jwa.HS256, signingKey))
	if err != nil {
		return "", errInvalidSignature
	}

	// å°†ä»¤ç‰Œè½½è·è§£å¯†
	decrypted, err := jwe.Decrypt(payload, jwe.WithKey(jwa.PBES2_HS512_A256KW, encryptKey))
	if err != nil {
		return "", errInvalidKey
	}

	tokenBytes = decrypted

	payloadJson := gjson.ParseBytes(tokenBytes)

	if time.Now().Unix() <= payloadJson.Get("nbf").Int() {
		return "", errTokenNotValidYet
	}

	if time.Now().Unix() > payloadJson.Get("exp").Int() {
		return "", errTokenExpired
	}

	return string(tokenBytes), nil
}
```

#### ä»¤ç‰Œå­˜å‚¨

é¢å‘ä»¤ç‰Œæ—¶å…ˆæ£€æµ‹redisä¸­æœ‰æ— ç°å­˜çš„ä»¤ç‰Œï¼Œè¿™æ ·å¯ä»¥é¿å…é‡å¤é¢å‘ä»¤ç‰Œï¼Œ

æ­¤å¤–ï¼Œåç»­å¯ä»¥æ ¹æ®è¯¥åŠŸèƒ½å®ç°çš„ä»¤ç‰Œçš„é»‘åå•åŠŸèƒ½

##### ç¼“å­˜è®¾è®¡

- keyï¼š`auth:oauth2_token:{obj}`

- valueï¼š

    ```json
    {
        "token_value": "eyJhbGciOiJIUzI1NiIsImN0eSI6IkpXVCJ9.ZXlKaGJHY2lPaUpRUWtWVE1pMUlVelV4TWl0Qk1qVTJTMWNpTENKbGJtTWlPaUpCTWpVMlIwTk5JaXdpY0RKaklqb3hNREF3TUN3aWNESnpJam9pZUVGclYwcEhkR3BwTVU1TlZHOURVMk16VW05c2FtWkZTSEF3UkVnNU9EZFVTekJFVVRZeGVWZ3ljeUlzSW5SNWNDSTZJa3BYVkNKOS5WMURrR2daWGhzbTJrTDg5bVFpNmZpTk1qeUdpUEVLMG90RU82a2xCQ3BaLWNrMkJFRTZlNUEuNXBHLW1rSXlmQ0tQSTh5ai4wUU8xSkRja19ka2I4YVVSUVU3aE5fV1NlUmJuSmJscldPSERTWWVXLTRka2JrcTFobHZZSFhlVFhDNEhPUUVDak1FSEdwYmM2aXRKT2ZJWDhtQTBZLWVQQVJwX2ZuVXVseDhlSl9EOVo0NnlXOVRlcG94WGtlVHpIQ0VZMm9JWmRmRGVEbUNMY0FtT1FYVjZMd3oxZTY1WmhURmhPdTNSVDJJcExnaEczaTBwU0t1djBkazFySEJVMGgxQ3BPWWRvaGtVMEEuV1N1UDVlaXhES0lYRXdaQlNHMEc4Zw.XPNcH7ItFYahj6cd7YegdzYGThvZ3aiqpcE-m74Y2Ls",
        "expires_at": 1674708117
    }
    ```

- TTLï¼š7d

### ç”¨æˆ·æ¨¡å—è®¾è®¡

#### éœ€æ±‚åˆ†æ

æœ¬æ¨¡å—åŒ…æ‹¬ç”¨æˆ·æ³¨å†Œä¸ç™»å½•ã€ç”¨æˆ·ä¿¡æ¯å’Œç”¨æˆ·å…³æ³¨æ“ä½œä¸‰ä¸ªéƒ¨åˆ†

##### ç”¨æˆ·æ³¨å†Œä¸ç™»å½•

- `/douyin/user/register` - **ç”¨æˆ·æ³¨å†Œæ¥å£**

    æ–°ç”¨æˆ·æ³¨å†Œæ—¶æä¾›ç”¨æˆ·åï¼Œå¯†ç ï¼Œæ˜µç§°å³å¯ï¼Œç”¨æˆ·åéœ€è¦ä¿è¯å”¯ä¸€ã€‚åˆ›å»ºæˆåŠŸåè¿”å›ç”¨æˆ· id å’Œæƒé™token

    ```go
    type (
    	RegisterReq {
    		Username string `form:"username"` // æ³¨å†Œç”¨æˆ·åï¼Œæœ€é•¿32ä¸ªå­—ç¬¦
    		Password string `form:"password"` // å¯†ç ï¼Œæœ€é•¿32ä¸ªå­—ç¬¦
    	}
    	RegisterRes {
    		StatusCode uint32 `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
    		UserId     int64  `json:"user_id,omitempty"` // ç”¨æˆ·id
    		Token      string `json:"token,omitempty"` // ç”¨æˆ·é‰´æƒtoken
    	}
    )
    ```

- `/douyin/user/login` - **ç”¨æˆ·ç™»å½•æ¥å£**

    é€šè¿‡ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•ï¼Œç™»å½•æˆåŠŸåè¿”å›ç”¨æˆ· id å’Œæƒé™ token.

    ```go
    type (
    	LoginReq {
    		Username string `form:"username"` // ç™»å½•ç”¨æˆ·å
    		Password string `form:"password"` // å¯†ç 
    	}
    	LoginRes {
    		StatusCode uint32 `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
    		UserId     int64  `json:"user_id,omitempty"` // ç”¨æˆ·id
    		Token      string `json:"token,omitempty"` // ç”¨æˆ·é‰´æƒtoken
    	}
    )
    ```

##### ç”¨æˆ·ä¿¡æ¯

- /`douyin/user` - **ç”¨æˆ·ä¿¡æ¯**

    è·å–ç™»å½•ç”¨æˆ·çš„ idã€æ˜µç§°ï¼Œå¦‚æœå®ç°ç¤¾äº¤éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œè¿˜ä¼šè¿”å›å…³æ³¨æ•°å’Œç²‰ä¸æ•°ã€‚

    ```go
    type (
    	GetProfileReq {
    		UserId string `form:"user_id"` // ç”¨æˆ·id
    		Token  string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
    	}
    	GetProfileRes {
    		StatusCode uint32   `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string   `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
    		User       *Profile `json:"user,omitempty"` // ç”¨æˆ·ä¿¡æ¯
    	}
    )
    
    type (
    	Profile {
    		Id            int64  `json:"id"` // ç”¨æˆ·id
    		Name          string `json:"name"` // ç”¨æˆ·åç§°
    		FollowCount   int64  `json:"follow_count"` // å…³æ³¨æ€»æ•°
    		FollowerCount int64  `json:"follower_count"` // ç²‰ä¸æ€»æ•°
    		IsFollow      bool   `json:"is_follow"` // true-å·²å…³æ³¨ï¼Œfalse-æœªå…³æ³¨
    	}
    )
    ```

##### ç”¨æˆ·å…³æ³¨

- `/douyin/relation` - **å…³ç³»æ“ä½œ**

    å®ç°ç”¨æˆ·ä¹‹é—´çš„å…³æ³¨å…³ç³»ç»´æŠ¤ï¼Œç™»å½•ç”¨æˆ·èƒ½å¤Ÿå…³æ³¨æˆ–å–å…³å…¶ä»–ç”¨æˆ·ï¼ŒåŒæ—¶è‡ªå·±èƒ½å¤Ÿçœ‹åˆ°è‡ªå·±å…³æ³¨è¿‡çš„æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ï¼Œä»¥åŠæ‰€æœ‰å…³æ³¨è‡ªå·±çš„ç”¨æˆ·åˆ—è¡¨ã€‚

    ```go
    type (
    	RelationReq {
    		Token      string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
    		ToUserId   string `form:"to_user_id"` // å¯¹æ–¹ç”¨æˆ·id
    		ActionType string `form:"action_type"` // 1-å…³æ³¨ï¼Œ2-å–æ¶ˆå…³æ³¨
    	}
    	RelationRes {
    		StatusCode uint32 `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
    	}
    )
    ```

- `/douyin/relation/follow/list` - **ç”¨æˆ·å…³æ³¨åˆ—è¡¨**

    ç™»å½•ç”¨æˆ·å…³æ³¨çš„æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ã€‚

    ```go
    type (
    	GetFollowListReq {
    		UserId string `form:"user_id"` // ç”¨æˆ·id
    		Token  string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
    	}
    	GetFollowListRes {
    		StatusCode uint32      `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string      `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
            UserList   interface{} `json:"user_list,omitempty"` // ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨, interface{} = GetFollowListRes.Profile
    	}
    )
    ```

    ```protobuf
    message GetFollowListReq{
        int64 src_user_id=1;
        int64 dst_user_id=2;
    }
    message GetFollowListRes{
        uint32 status_code = 1;
        string status_msg = 2;
        repeated Profile user_list=3;
    }
    
    message Profile{
        int64 id=1; // ç”¨æˆ·id
        string name=2; // ç”¨æˆ·åç§°
        int64 follow_count=3; // å…³æ³¨æ€»æ•°
        int64 follower_count=4; // ç²‰ä¸æ€»æ•°
        bool is_follow=5; // true-å·²å…³æ³¨ï¼Œfalse-æœªå…³æ³¨
    }
    ```
- `/douyin/relation/follower/list` - **ç”¨æˆ·ç²‰ä¸åˆ—è¡¨**

    æ‰€æœ‰å…³æ³¨ç™»å½•ç”¨æˆ·çš„ç²‰ä¸åˆ—è¡¨ã€‚

      ```go
      type (
      	GetFollowerListReq {
      		UserId string `form:"user_id"` // ç”¨æˆ·id
      		Token  string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
      	}
      	GetFollowerListRes {
      		StatusCode uint32      `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
      		StatusMsg  string      `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
      		UserList   interface{} `json:"user_list,omitempty"` // ç”¨æˆ·åˆ—è¡¨, interface{} = GetFollowerListRes.Profile
      	}
      )
      ```

    ```protobuf
    message GetFollowerListReq{
        int64 src_user_id=1;
        int64 dst_user_id=2;
    }
    message GetFollowerListRes{
        uint32 status_code = 1;
        string status_msg = 2;
        repeated Profile user_list=3;
    }
    
    message Profile{
        int64 id=1; // ç”¨æˆ·id
        string name=2; // ç”¨æˆ·åç§°
        int64 follow_count=3; // å…³æ³¨æ€»æ•°
        int64 follower_count=4; // ç²‰ä¸æ€»æ•°
        bool is_follow=5; // true-å·²å…³æ³¨ï¼Œfalse-æœªå…³æ³¨
    }
    ```
- `/douyin/relation/friend/list` - **ç”¨æˆ·å¥½å‹åˆ—è¡¨**

    æ‰€æœ‰å…³æ³¨ç™»å½•ç”¨æˆ·çš„ç²‰ä¸åˆ—è¡¨ã€‚

    ```go
    type (
    	GetFriendListReq {
    		UserId string `form:"user_id"` // ç”¨æˆ·id
    		Token  string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
    	}
    	GetFriendListRes {
    		StatusCode uint32      `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string      `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
    		UserList   interface{} `json:"user_list,omitempty"` // ç”¨æˆ·åˆ—è¡¨, interface{} = GetFriendListRes.Profile
    	}
    )
    ```

    ```protobuf
    message GetFriendListReq{
        int64 src_user_id=1;
        int64 dst_user_id=2;
    }
    message GetFriendListRes{
        uint32 status_code = 1;
        string status_msg = 2;
        repeated Profile user_list=3;
    }
    
    message Profile{
        int64 id=1; // ç”¨æˆ·id
        string name=2; // ç”¨æˆ·åç§°
        int64 follow_count=3; // å…³æ³¨æ€»æ•°
        int64 follower_count=4; // ç²‰ä¸æ€»æ•°
        bool is_follow=5; // true-å·²å…³æ³¨ï¼Œfalse-æœªå…³æ³¨
    }
    ```

#### æ¶æ„è®¾è®¡

<img src="./manifest/docs/image/user-module.png">

#### æ¥å£è®¾è®¡

##### ç”¨æˆ·æ³¨å†Œä¸ç™»å½•



### è§†é¢‘æ¨¡å—è®¾è®¡

æœ¬æ¨¡å—åŒ…æ‹¬è§†é¢‘çš„è·å–ä¸æŠ•ç¨¿ã€è§†é¢‘å–œæ¬¢å’Œè§†é¢‘è¯„è®ºä¸‰ä¸ªéƒ¨åˆ†

#### éœ€æ±‚åˆ†æ

##### è§†é¢‘çš„è·å–ä¸æŠ•ç¨¿

- `/douyin/feed` - **è§†é¢‘æµæ¥å£**

    ä¸é™åˆ¶ç™»å½•çŠ¶æ€ï¼Œè¿”å›æŒ‰æŠ•ç¨¿æ—¶é—´å€’åºçš„è§†é¢‘åˆ—è¡¨ï¼Œè§†é¢‘æ•°ç”±æœåŠ¡ç«¯æ§åˆ¶ï¼Œå•æ¬¡æœ€å¤š30ä¸ªã€‚
    
    ```go
    type (
    	FeedReq {
    		LastestTime string `form:"latest_time,optional"` // å¯é€‰å‚æ•°ï¼Œé™åˆ¶è¿”å›è§†é¢‘çš„æœ€æ–°æŠ•ç¨¿æ—¶é—´æˆ³ï¼Œç²¾ç¡®åˆ°ç§’ï¼Œä¸å¡«è¡¨ç¤ºå½“å‰æ—¶é—´
    		Token       string `form:"token,optional"` // å¯é€‰å‚æ•°ï¼Œç™»å½•ç”¨æˆ·è®¾ç½®
    	}
    	FeedRes {
    		StatusCode uint32      `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string      `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
    		NextTime   int64       `json:"next_time,omitempty"` // æœ¬æ¬¡è¿”å›çš„è§†é¢‘ä¸­ï¼Œå‘å¸ƒæœ€æ—©çš„æ—¶é—´ï¼Œä½œä¸ºä¸‹æ¬¡è¯·æ±‚æ—¶çš„latest_time
            VideoList  interface{} `json:"video_list,omitempty"` // è§†é¢‘åˆ—è¡¨, interface{} = FeedRes.Videos
    	}
    )
    ```
    
    ```protobuf
    message FeedReq{
        int64 latest_time=1;
        int64 user_id=2;
    }
    message FeedRes{
        uint32 status_code = 1;
        string status_msg = 2;
        repeated Video videos = 3;
        int64 next_time=4;
    }
    
    message Video{
        int64 id=1; // è§†é¢‘å”¯ä¸€æ ‡è¯†
        Profile user=2; // è§†é¢‘ä½œè€…ä¿¡æ¯
        string play_url=3; // è§†é¢‘æ’­æ”¾åœ°å€
        string cover_url=4; // è§†é¢‘å°é¢åœ°å€
        int64 favorite_count=5; // è§†é¢‘çš„ç‚¹èµæ€»æ•°
        int64 comment_count=6; // è§†é¢‘çš„è¯„è®ºæ€»æ•°
        bool is_favorite=7; // true-å·²ç‚¹èµï¼Œfalse-æœªç‚¹èµ
        string title=8; // è§†é¢‘æ ‡é¢˜
    }
    ```

- `/douyin/publish/action` - **è§†é¢‘æŠ•ç¨¿**

    ç™»å½•ç”¨æˆ·é€‰æ‹©è§†é¢‘ä¸Šä¼ ã€‚

    ```go
    type (
    	PublishReq {
    		Token string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
            Data os.File `form:"data"` // è§†é¢‘æ•°æ®
    		Title string `form:"title"` // è§†é¢‘æ ‡é¢˜
    	}
    	PublishRes {
    		StatusCode uint32 `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
    	}
    )
    ```

##### è§†é¢‘å–œæ¬¢

- `/douyin/favorite/action` - **èµæ“ä½œ**

    ```go
    type (
    	FavoriteReq {
    		Token      string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
    		VideoId    string `form:"video_id"` // è§†é¢‘id
    		ActionType string `form:"action_type"` // 1-ç‚¹èµï¼Œ2-å–æ¶ˆç‚¹èµ
    	}
    	FavoriteRes {
    		StatusCode uint32 `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
    	}
    )
    ```

- `/douyin/favorite/list` - **å–œæ¬¢åˆ—è¡¨**

    ```go
    type (
    	GetFavoriteListReq {
    		UserId string `form:"user_id"` // ç”¨æˆ·id
    		Token  string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
    	}
    	GetFavoriteListRes {
    		StatusCode uint32      `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string      `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
            VideoList  interface{} `json:"video_list,omitempty"` // ç”¨æˆ·ç‚¹èµè§†é¢‘åˆ—è¡¨, interface{} = GetfavoriteListRes.Videos
    	}
    )
    ```

    ```protobuf
    message GetFavoriteListReq{
        int64 src_user_id=1;
        int64 dst_user_id=2;
    }
    message GetFavoriteListRes{
        uint32 status_code = 1;
        string status_msg = 2;
        repeated Video videos = 3;
    }
    
    message Video{
        int64 id=1; // è§†é¢‘å”¯ä¸€æ ‡è¯†
        Profile user=2; // è§†é¢‘ä½œè€…ä¿¡æ¯
        string play_url=3; // è§†é¢‘æ’­æ”¾åœ°å€
        string cover_url=4; // è§†é¢‘å°é¢åœ°å€
        int64 favorite_count=5; // è§†é¢‘çš„ç‚¹èµæ€»æ•°
        int64 comment_count=6; // è§†é¢‘çš„è¯„è®ºæ€»æ•°
        bool is_favorite=7; // true-å·²ç‚¹èµï¼Œfalse-æœªç‚¹èµ
        string title=8; // è§†é¢‘æ ‡é¢˜
    }
    message Profile{
        int64 id=1; // ç”¨æˆ·id
        string name=2; // ç”¨æˆ·åç§°
        int64 follow_count=3; // å…³æ³¨æ€»æ•°
        int64 follower_count=4; // ç²‰ä¸æ€»æ•°
        bool is_follow=5; // true-å·²å…³æ³¨ï¼Œfalse-æœªå…³æ³¨
    }
    ```

##### è§†é¢‘è¯„è®º

- `/douyin/comment/action` - **è¯„è®ºæ“ä½œ**

    ```go
    type (
    	CommentReq {
    		Token       string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
    		VideoId     string `form:"video_id"` // è§†é¢‘id
    		ActionType  string `form:"action_type"` // 1-å‘å¸ƒè¯„è®ºï¼Œ2-åˆ é™¤è¯„è®º
    		CommentText string `form:"comment_text,optional"` // ç”¨æˆ·å¡«å†™çš„è¯„è®ºå†…å®¹ï¼Œåœ¨action_type=1çš„æ—¶å€™ä½¿ç”¨
    		CommentId   string `form:"comment_id,optional"` // è¦åˆ é™¤çš„è¯„è®ºidï¼Œåœ¨action_type=2çš„æ—¶å€™ä½¿ç”¨
    	}
    	CommentRes {
    		StatusCode uint32      `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string      `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
            Comment    interface{} `json:"comment,omitempty"` // è¯„è®ºæˆåŠŸè¿”å›è¯„è®ºå†…å®¹ï¼Œä¸éœ€è¦é‡æ–°æ‹‰å–æ•´ä¸ªåˆ—è¡¨, interface{} = CommentRes.Comment
    	}
    )
    ```

    ```protobuf
    message CommentReq{
        int64 user_id=1;
        int64 video_id=2;
        uint32 action_type=3;
        string comment_text=4;
        int64 comment_id=5;
    }
    message CommentRes{
        uint32 status_code = 1;
        string status_msg = 2;
        Comment comment = 3;
    }
    
    message Comment{
        int64 id=1; // è§†é¢‘è¯„è®ºid
        Profile user=2; // è¯„è®ºç”¨æˆ·ä¿¡æ¯
        string content=3; // è¯„è®ºå†…å®¹
        string create_date=4; // è¯„è®ºå‘å¸ƒæ—¥æœŸï¼Œæ ¼å¼ mm-dd
    }
    message Profile{
        int64 id=1; // ç”¨æˆ·id
        string name=2; // ç”¨æˆ·åç§°
        int64 follow_count=3; // å…³æ³¨æ€»æ•°
        int64 follower_count=4; // ç²‰ä¸æ€»æ•°
        bool is_follow=5; // true-å·²å…³æ³¨ï¼Œfalse-æœªå…³æ³¨
    }
    ```

- `/douyin/comment/list` - **è§†é¢‘è¯„è®ºåˆ—è¡¨**

    ```go
    type (
    	GetCommentListReq {
    		Token   string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
    		VideoId string `form:"video_id"` // è§†é¢‘id
    	}
    	GetCommentListRes {
    		StatusCode  uint32      `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg   string      `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
            CommentList interface{} `json:"comment_list,omitempty"` // è¯„è®ºåˆ—è¡¨, interface{} = GetCommentListRes.Comments
    	}
    )
    ```

    ```protobuf
    message GetCommentListReq{
        int64 user_id=1;
        int64 video_id=2;
    }
    message GetCommentListRes{
        uint32 status_code = 1;
        string status_msg = 2;
        repeated Comment comments = 3;
    }
    
    message Comment{
        int64 id=1; // è§†é¢‘è¯„è®ºid
        Profile user=2; // è¯„è®ºç”¨æˆ·ä¿¡æ¯
        string content=3; // è¯„è®ºå†…å®¹
        string create_date=4; // è¯„è®ºå‘å¸ƒæ—¥æœŸï¼Œæ ¼å¼ mm-dd
    }
    message Profile{
        int64 id=1; // ç”¨æˆ·id
        string name=2; // ç”¨æˆ·åç§°
        int64 follow_count=3; // å…³æ³¨æ€»æ•°
        int64 follower_count=4; // ç²‰ä¸æ€»æ•°
        bool is_follow=5; // true-å·²å…³æ³¨ï¼Œfalse-æœªå…³æ³¨
    }
    ```

#### æ¶æ„è®¾è®¡

<img src="./manifest/docs/image/video-module.png">

### èŠå¤©æ¨¡å—è®¾è®¡

æœ¬æ¨¡å—æœ‰å‘é€æ¶ˆæ¯å’Œè·å–æ¶ˆæ¯ä¸¤ä¸ªæ“ä½œ

#### éœ€æ±‚åˆ†æ

- `/douyin/message/action` - **æ¶ˆæ¯æ“ä½œ**

    ```go
    type (
    	SendMessageReq {
    		Token      string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
    		ToUserId   string `form:"to_user_id"` // å¯¹æ–¹ç”¨æˆ·id
    		ActionType string `form:"action_type"` // 1-å‘é€æ¶ˆæ¯
    		Content    string `form:"content,optional"` // æ¶ˆæ¯å†…å®¹
    	}
    	SendMessageRes {
    		StatusCode uint32 `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg  string `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
    	}
    )
    ```

- `/douyin/message/chat` - **èŠå¤©è®°å½•**

    ```go
    type (
    	GetMessageListReq {
    		Token    string `form:"token"` // ç”¨æˆ·é‰´æƒtoken
    		ToUserId string `form:"to_user_id"` // å¯¹æ–¹ç”¨æˆ·id
    	}
    	GetMessageListRes {
    		StatusCode  uint32      `json:"status_code"` // çŠ¶æ€ç ï¼Œ0-æˆåŠŸï¼Œå…¶ä»–å€¼-å¤±è´¥
    		StatusMsg   string      `json:"status_msg"` // è¿”å›çŠ¶æ€æè¿°
            MessageList interface{} `json:"message_list,omitempty"` // æ¶ˆæ¯åˆ—è¡¨, interface{} = GetMessageRes.Messages
    	}
    )
    ```

    ```protobuf
    message GetMessageReq{
        int64 src_user_id=1;
        int64 dst_user_id=2;
    }
    message GetMessageRes{
        uint32 status_code=1;
        string status_msg=2;
        repeated Message messages = 3;
    }
    
    message Message{
        int64 id=1; // æ¶ˆæ¯id
        string content=2; // æ¶ˆæ¯å†…å®¹
        string create_time=3; // æ¶ˆæ¯åˆ›å»ºæ—¶é—´
    }
    ```

#### æ¶æ„è®¾è®¡

<img src="./manifest/docs/image/chat-module.png">

## ğŸ›  å¼€å‘å‡†å¤‡

## ğŸ“Œ TODO

- [ ] ç¼“å­˜
- [ ] è§†é¢‘æˆªå›¾ä½œä¸ºè§†é¢‘å°é¢

## ğŸˆ è´¡çŒ®è€…

- [StellarisW](https://github.com/StellarisW)

- [Snluna](https://github.com/Snluna)

## ğŸ—é¸£è°¢

- [å­—èŠ‚è·³åŠ¨é’è®­è¥](https://youthcamp.bytedance.com/)



## æ”¹è¿›ç‚¹

- è€ƒè™‘åˆ°æ¥å£æ–‡æ¡£é™åˆ¶ï¼Œæ²¡æœ‰åšåˆ†é¡µå¤„ç†